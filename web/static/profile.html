<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - 博客系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* 顶部导航栏 */
        .navbar {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar-brand {
            font-size: 24px;
            font-weight: 600;
            color: #007bff;
            text-decoration: none;
        }
        .navbar-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar-nav li {
            margin-left: 20px;
        }
        .navbar-nav a {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .navbar-nav a:hover {
            color: #007bff;
        }
        .logout-btn {
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .logout-btn:hover {
            color: #007bff;
        }
        /* 内容区域 */
        .content {
            flex: 1;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            gap: 30px;
        }
        .user-section {
            flex: 0 0 300px;
        }
        .user-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 30px;
            text-align: center;
        }
        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
        }
        .user-name {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .user-info-list {
            margin-top: 20px;
            text-align: left;
        }
        .user-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .user-info-item:last-child {
            border-bottom: none;
        }
        .user-info-label {
            color: #666;
            font-weight: 500;
        }
        .user-info-value {
            font-weight: 600;
        }
        .posts-section {
            flex: 1;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        .add-post-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }
        .add-post-btn:hover {
            background-color: #0069d9;
        }
        .add-icon {
            margin-right: 5px;
        }
        .post-list {
            display: grid;
            gap: 20px;
        }
        .post-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .post-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        .post-excerpt {
            color: #666;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #888;
        }
        .post-date {
            display: flex;
            align-items: center;
        }
        .date-icon {
            margin-right: 5px;
        }
        .post-actions {
            display: flex;
            gap: 10px;
        }
        .action-btn {
            background-color: transparent;
            color: #007bff;
            border: 1px solid #007bff;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.3s;
        }
        .action-btn:hover {
            background-color: #007bff;
            color: white;
        }
        .edit-btn {
            border-color: #28a745;
            color: #28a745;
        }
        .edit-btn:hover {
            background-color: #28a745;
            color: white;
        }
        .delete-btn {
            border-color: #dc3545;
            color: #dc3545;
        }
        .delete-btn:hover {
            background-color: #dc3545;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">
            <i class="fas fa-blog"></i> 博客系统
        </a>
        <ul class="navbar-nav">
            <li><a href="/">首页</a></li>
            <li><a href="#" id="create-post-link" style="display:none;">写文章</a></li>
            <li><span class="username" id="username"></span></li>
            <li><a href="#" class="logout-btn" id="logout-btn">退出登录</a></li>
        </ul>
    </nav>

    <main class="content">
        <div class="user-section">
            <div id="user-card" class="user-card">
                <!-- 用户信息将通过JavaScript动态加载 -->
            </div>
        </div>

        <div class="posts-section">
            <div class="section-header">
                <h2 class="section-title">我的文章</h2>
                <a href="/posts/create-post" class="add-post-btn">
                    <i class="fas fa-plus add-icon"></i>
                    新增文章
                </a>
            </div>
            
            <div id="error-container"></div>
            <div id="loading" class="loading">加载中...</div>
            
            <div id="post-list" class="post-list" style="display: none;">
                <!-- 文章列表将通过JavaScript动态加载 -->
            </div>
            
            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-file-alt empty-icon"></i>
                <p>您还没有发布任何文章</p>
                <p>点击右上角的"新增文章"按钮创建您的第一篇文章</p>
            </div>
        </div>
    </main>

    <script>
        // 检查用户登录状态
        async function checkUserStatus() {
            // 获取token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            const token = getCookie('token') || localStorage.getItem('token') || sessionStorage.getItem('token');

            if (!token) {
                // 没有token，重定向到登录页面
                window.location.href = '/login';
                return;
            }
            
            try {
                const response = await fetch('/api/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    credentials: 'include' // 包含cookie
                });
                const data = await response.json();
                // 移除错误的代码，因为我们不需要修改user-section的内容

                if (response.ok && data.success && data.data) {
                    // 用户已登录
                    // 更新导航栏中的用户名
                    const usernameElement = document.getElementById('username');
                    if (usernameElement) {
                        usernameElement.textContent = data.data.user_name;
                    }

                    console.log("22222222222222222")
                    // 加载用户详细信息
                    loadUserInfo(data.data.id);
                    
                    // 加载用户文章
                    loadUserPosts(data.data.id);
                } else {

                    // 用户未登录，重定向到登录页面
                    window.location.href = '/login';
                }
            } catch (error) {
                // 重定向到登录页面
                window.location.href = '/login?error='+error;
            }
        }

        // 加载用户信息
        async function loadUserInfo(userId) {
            // 获取token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }
            
            const token = getCookie('token') || localStorage.getItem('token') || sessionStorage.getItem('token');
            
            try {
                // 使用已有的用户信息，不再需要额外请求
                const response = await fetch('/api/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    credentials: 'include' // 包含cookie
                });
                const data = await response.json();
                
                if (response.ok && data.success && data.data) {
                    const userCard = document.getElementById('user-card');
                    userCard.innerHTML = `
                        <div class="user-avatar">${data.data.user_name.charAt(0).toUpperCase()}</div>
                        <div class="user-name">${data.data.user_name}</div>
                        <div class="user-info-list">
                            <div class="user-info-item">
                                <span class="user-info-label">邮箱</span>
                                <span class="user-info-value">${data.data.email}</span>
                            </div>
                            <div class="user-info-item">
                                <span class="user-info-label">文章数</span>
                                <span class="user-info-value" id="post-count">0</span>
                            </div>
                            <div class="user-info-item">
                                <span class="user-info-label">注册时间</span>
                                <span class="user-info-value">${new Date().toLocaleDateString()}</span>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || '加载用户信息失败');
                }
            } catch (error) {
                console.error('加载用户信息失败:', error);
            }
        }

        // 加载用户文章
        async function loadUserPosts(userId) {
            // 获取token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }
            
            const token = getCookie('token') || localStorage.getItem('token') || sessionStorage.getItem('token');
            
            const loading = document.getElementById('loading');
            const postList = document.getElementById('post-list');
            const emptyState = document.getElementById('empty-state');
            const errorContainer = document.getElementById('error-container');
            
            // 显示加载状态
            loading.style.display = 'block';
            postList.style.display = 'none';
            emptyState.style.display = 'none';
            errorContainer.innerHTML = '';
            
            try {
                // 使用现有的API端点获取用户文章
                const response = await fetch(`/api/user/${userId}/posts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    credentials: 'include' // 包含cookie
                });
                const data = await response.json();
                
                if (response.ok) {
                    // 隐藏加载状态
                    loading.style.display = 'none';
                    
                    // 更新文章数量
                    const postCountElement = document.getElementById('post-count');
                    if (postCountElement) {
                        postCountElement.textContent = data.posts ? data.posts.length : 0;
                    }
                    
                    if (data.posts && data.posts.length > 0) {
                        // 显示文章列表
                        postList.style.display = 'grid';
                        
                        // 清空现有内容
                        postList.innerHTML = '';
                        
                        // 渲染文章列表
                        data.posts.forEach(post => {
                            const postCard = document.createElement('div');
                            postCard.className = 'post-card';
                            postCard.innerHTML = `
                                <h3 class="post-title">${post.title}</h3>
                                <p class="post-excerpt">${post.content.substring(0, 150)}...</p>
                                <div class="post-meta">
                                    <div class="post-date">
                                        <i class="fas fa-calendar date-icon"></i>
                                        <span>${new Date(post.created_at).toLocaleDateString()}</span>
                                    </div>
                                    <div class="post-actions">
                                        <a href="/post/${post.id}" class="action-btn">查看</a>
                                        <a href="/posts/edit-post/${post.id}" class="action-btn edit-btn">编辑</a>
                                        <button class="action-btn delete-btn" data-id="${post.id}">删除</button>
                                    </div>
                                </div>
                            `;
                            
                            // 添加删除事件
                            const deleteBtn = postCard.querySelector('.delete-btn');
                            deleteBtn.addEventListener('click', () => {
                                if (confirm('确定要删除这篇文章吗？')) {
                                    deletePost(post.id);
                                }
                            });
                            
                            postList.appendChild(postCard);
                        });
                    } else {
                        // 显示空状态
                        emptyState.style.display = 'block';
                    }
                } else {
                    throw new Error(data.message || '加载文章失败');
                }
            } catch (error) {
                console.error('加载文章失败:', error);
                loading.style.display = 'none';
                errorContainer.innerHTML = `<div class="error-message">加载文章失败: ${error.message}</div>`;
            }
        }

        // 删除文章
        async function deletePost(postId) {
            // 获取token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }
            
            const token = getCookie('token') || localStorage.getItem('token') || sessionStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/post/${postId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    credentials: 'include' // 包含cookie
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // 重新加载文章列表
                    checkUserStatus();
                } else {
                    throw new Error(data.message || '删除文章失败');
                }
            } catch (error) {
                console.error('删除文章失败:', error);
                alert(`删除文章失败: ${error.message}`);
            }
        }

        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', () => {
            checkUserStatus();
            
            // 添加写文章链接事件
            document.getElementById('create-post-link').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = '/posts/create-post';
            });
        });
    </script>
</body>
</html>